<!DOCTYPE html>
<html>
<head>
  <title><%= content_for?(:meta_title) ? yield(:meta_title) : "Location de salles" %></title>
  <meta name="description" content="<%= content_for?(:meta_description) ? yield(:meta_description) : "Trouvez la salle parfaite pour votre événement" %>">
  <%= yield(:canonical_link) if content_for?(:canonical_link) %>
  <%= yield(:og_tags) if content_for?(:og_tags) %>
  <meta name="robots" content="index, follow">
  
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
  <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
  
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCA4aUHK_Zd40CQFJLr5VYF_HOfTT-hSGM&callback=initMap&libraries=maps,marker&v=beta">
  </script>
  <style>
    gmp-map {
      height: 400px;
      width: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #search-container {
      padding: 10px;
    }
    #results-container {
      padding: 10px;
    }
  </style>
</head>

<body>
  <%= render 'layouts/navigation' %>
  <p class="notice"><%= notice %></p>
  <p class="alert"><%= alert %></p>

  <div id="search-container">
    <input id="search-input" type="text" placeholder="Entrez une adresse ou un code postal">
    <button id="search-button">Rechercher</button>
  </div>

  <gmp-map center="46.603354,1.888334" zoom="6" map-id="DEMO_MAP_ID">
  </gmp-map>

  <div id="results-container"></div>

  <%= yield %>

  <script>
    let map;
    let markers = [];

    function initMap() {
      map = document.querySelector('gmp-map');
      const searchButton = document.getElementById('search-button');
      const searchInput = document.getElementById('search-input');

      searchButton.addEventListener('click', performSearch);
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }

    function performSearch() {
      const searchValue = document.getElementById('search-input').value;
      const geocoder = new google.maps.Geocoder();

      geocoder.geocode({ address: searchValue + ', France' }, (results, status) => {
        if (status === 'OK') {
          const position = results[0].geometry.location;
          map.center = `${position.lat()},${position.lng()}`;
          map.zoom = 13;

          // Effacer les anciens marqueurs
          markers.forEach(marker => marker.remove());
          markers = [];

          // Rechercher les espaces à proximité (simulé ici)
          searchSpaces(position.lat(), position.lng());
        } else {
          alert('La géolocalisation a échoué pour la raison suivante : ' + status);
        }
      });
    }

    function searchSpaces(lat, lng) {
      // Simulation de la recherche d'espaces
      // Dans une vraie application, vous feriez un appel AJAX à votre serveur ici
      const spaces = [
        { id: 1, name: "Espace A", lat: lat + 0.01, lng: lng + 0.01 },
        { id: 2, name: "Espace B", lat: lat - 0.01, lng: lng - 0.01 },
        { id: 3, name: "Espace C", lat: lat, lng: lng + 0.02 }
      ];

      const resultsContainer = document.getElementById('results-container');
      resultsContainer.innerHTML = '';

      spaces.forEach(space => {
        const marker = document.createElement('gmp-advanced-marker');
        marker.position = `${space.lat},${space.lng}`;
        marker.title = space.name;
        map.appendChild(marker);
        markers.push(marker);

        const spaceElement = document.createElement('div');
        spaceElement.innerHTML = `<h3>${space.name}</h3><p>Latitude: ${space.lat}, Longitude: ${space.lng}</p>`;
        resultsContainer.appendChild(spaceElement);
      });
    }
  </script>
</body>
</html>