<!DOCTYPE html>
<html>
<head>
  <title><%= content_for?(:meta_title) ? yield(:meta_title) : "Location de salles" %></title>
  <meta name="description" content="<%= content_for?(:meta_description) ? yield(:meta_description) : "Trouvez la salle parfaite pour votre événement" %>">
  <%= yield(:canonical_link) if content_for?(:canonical_link) %>
  <%= yield(:og_tags) if content_for?(:og_tags) %>
  <meta name="robots" content="index, follow">
  
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
  <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
  
  <style>
    #map {
      height: 400px;
      width: 100%;
      margin-top: 20px;
    }
    #search-container {
      margin: 20px 0;
    }
  </style>
</head>

<body>
  <%= render 'layouts/navigation' %>
  <p class="notice"><%= notice %></p>
  <p class="alert"><%= alert %></p>
  
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Entrez un code postal ou une ville">
    <button onclick="geocodeAddress()">Rechercher</button>
  </div>

  <div id="map"></div>

  <%= yield %>

  <script>
    let map;
    let geocoder;
    let marker;

    function initMap() {
      console.log("Initialisation de la carte");
      geocoder = new google.maps.Geocoder();
      
      const france = { lat: 46.603354, lng: 1.888334 };
      
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: france,
      });

      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          geocodeAddress();
        }
      });
    }

    function geocodeAddress() {
      const address = document.getElementById('search-input').value + ', France';
      console.log("Recherche pour:", address);

      geocoder.geocode({ address: address }, (results, status) => {
        console.log("Statut:", status);
        console.log("Résultats:", results);

        if (status === "OK" && results[0]) {
          let targetLocation = results[0].geometry.location;
          
          // Chercher le résultat le plus précis (ville si possible)
          for (let result of results) {
            if (result.types.includes('locality')) {
              targetLocation = result.geometry.location;
              break;
            }
          }

          map.setCenter(targetLocation);
          map.setZoom(13);

          if (marker) {
            marker.setMap(null);
          }
          marker = new google.maps.Marker({
            map: map,
            position: targetLocation,
          });

          console.log("Emplacement trouvé:", results[0].formatted_address);
        } else {
          console.error("Erreur de géocodage:", status);
          alert("La géolocalisation a échoué. Veuillez réessayer.");
        }
      });
    }

    // Charger l'API Google Maps de manière asynchrone
    function loadGoogleMapsScript() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCA4aUHK_Zd40CQFJLr5VYF_HOfTT-hSGM&libraries=places&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    // Appeler la fonction pour charger le script
    loadGoogleMapsScript();
  </script>
</body>
</html>