<!DOCTYPE html>
<html>
<head>
  <title><%= content_for?(:meta_title) ? yield(:meta_title) : "Location de salles" %></title>
  <meta name="description" content="<%= content_for?(:meta_description) ? yield(:meta_description) : "Trouvez la salle parfaite pour votre événement" %>">
  <%= yield(:canonical_link) if content_for?(:canonical_link) %>
  <%= yield(:og_tags) if content_for?(:og_tags) %>
  <meta name="robots" content="index, follow">
  
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>


  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCA4aUHK_Zd40CQFJLr5VYF_HOfTT-hSGM&libraries=places" async defer></script>
  
  <style>
    #map 
    {
      height: 400px;
      width: 100%;
      margin-top: 20px;
    }
    #search-container 
    {
      margin: 20px 0;
    }
    #results-container 
    {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <%= render 'layouts/navigation' %>
  <p class="notice"><%= notice %></p>
  <p class="alert"><%= alert %></p>
  
  <h1>Bienvenue sur notre site de location de salles</h1>
  <p>Que ce soit pour un mariage, une conférence ou une réunion, nous avons la salle qu'il vous faut.</p>
  
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Entrez un département, une ville ou un code postal">
    <button onclick="performSearch()">Rechercher</button>
  </div>

  <div id="map"></div>
  <div id="results-container"></div>

  <%= yield %>

  <script>
    let map;
    let geocoder;
    let markers = [];

    function initMap() {
      geocoder = new google.maps.Geocoder();
      
      const france = { lat: 46.603354, lng: 1.888334 };
      
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: france,
      });

      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }

    function performSearch() {
      const searchQuery = document.getElementById('search-input').value;
      console.log("Recherche pour:", searchQuery);

      geocoder.geocode({ address: searchQuery + ', France' }, (results, status) => {
        console.log("Statut:", status);
        console.log("Résultats:", results);

        if (status === "OK" && results[0]) {
          let targetLocation = results[0].geometry.location;
          
          // Chercher le résultat le plus précis (ville ou département si possible)
          for (let result of results) {
            if (result.types.includes('locality') || result.types.includes('administrative_area_level_2')) {
              targetLocation = result.geometry.location;
              break;
            }
          }

          map.setCenter(targetLocation);
          map.setZoom(10);

          // Effacer les anciens marqueurs
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          // Créer un nouveau marqueur pour la localisation recherchée
          const marker = new google.maps.Marker({
            map: map,
            position: targetLocation,
          });
          markers.push(marker);

          console.log("Emplacement trouvé:", results[0].formatted_address);

          // Rechercher les salles dans cette zone
          searchSpaces(targetLocation.lat(), targetLocation.lng());
        } else {
          console.error("Erreur de géocodage:", status);
          alert("La géolocalisation a échoué. Veuillez réessayer.");
        }
      });
    }

    function searchSpaces(lat, lng) {
      // Faire une requête AJAX à votre backend pour obtenir les salles
      fetch(`/api/spaces?lat=${lat}&lng=${lng}`)
        .then(response => response.json())
        .then(spaces => {
          const resultsContainer = document.getElementById('results-container');
          resultsContainer.innerHTML = '<h2>Salles trouvées :</h2>';

          spaces.forEach(space => {
            // Ajouter un marqueur pour chaque salle
            const spaceMarker = new google.maps.Marker({
              map: map,
              position: { lat: space.latitude, lng: space.longitude },
              title: space.name
            });
            markers.push(spaceMarker);

            // Ajouter les détails de la salle dans la liste des résultats
            const spaceElement = document.createElement('div');
            spaceElement.innerHTML = `
              <h3>${space.name}</h3>
              <p>${space.address}</p>
              <p>Capacité: ${space.capacity} personnes</p>
              <p>Prix: ${space.price}€ par jour</p>
            `;
            resultsContainer.appendChild(spaceElement);
          });
        })
        .catch(error => {
          console.error("Erreur lors de la recherche des salles:", error);
          alert("Une erreur est survenue lors de la recherche des salles.");
        });
    }

    // Assurez-vous que la carte est initialisée même si le callback de l'API est retardé
    if (typeof google === 'object' && typeof google.maps === 'object') {
      initMap();
    } else {
      console.log("Attente de l'API Google Maps...");
    }
  </script>
</body>
</html>