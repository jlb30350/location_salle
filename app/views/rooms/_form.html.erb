<% if @room.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(@room.errors.count, "erreur") %> ont empêché cette salle d'être enregistrée :</h2>
    <ul>
      <% @room.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_with(model: @room, local: true, html: { onsubmit: "return checkPhotos();" }) do |form| %>
  <!-- Nom de la salle -->
  <div class="form-group <%= 'has-error' if @room.errors[:name].any? %>">
    <%= form.label :name, "Nom de la salle" %>
    <%= form.text_field :name, class: "form-control" %>
    <% if @room.errors[:name].any? %>
      <div class="text-danger">
        <%= @room.errors[:name].first %>
      </div>
    <% end %>
  </div>

  <!-- Description -->
  <div class="form-group <%= 'has-error' if @room.errors[:description].any? %>">
    <%= form.label :description, "Description" %>
    <%= form.text_area :description, class: "form-control" %>
    <% if @room.errors[:description].any? %>
      <div class="text-danger">
        <%= @room.errors[:description].first %>
      </div>
    <% end %>
  </div>

  <!-- Adresse -->
  <div class="form-group <%= 'has-error' if @room.errors[:address].any? %>">
    <%= form.label :address, "Adresse" %>
    <%= form.text_field :address, class: "form-control" %>
    <% if @room.errors[:address].any? %>
      <div class="text-danger">
        <%= @room.errors[:address].first %>
      </div>
    <% end %>
  </div>

  <!-- Ville -->
  <div class="form-group <%= 'has-error' if @room.errors[:city].any? %>">
    <%= form.label :city, "Ville" %>
    <%= form.text_field :city, class: "form-control" %>
    <% if @room.errors[:city].any? %>
      <div class="text-danger">
        <%= @room.errors[:city].first %>
      </div>
    <% end %>
  </div>

  <!-- Département -->
  <div class="form-group <%= 'has-error' if @room.errors[:department].any? %>">
    <%= form.label :department, "Département" %>
    <%= form.text_field :department, class: "form-control" %>
    <% if @room.errors[:department].any? %>
      <div class="text-danger">
        <%= @room.errors[:department].first %>
      </div>
    <% end %>
  </div>

  <!-- Superficie -->
  <div class="form-group <%= 'has-error' if @room.errors[:surface].any? %>">
    <%= form.label :surface, "Superficie (m²)" %>
    <%= form.number_field :surface, class: "form-control", min: 0, step: 1 %>
    <% if @room.errors[:surface].any? %>
      <div class="text-danger">
        <%= @room.errors[:surface].first %>
      </div>
    <% end %>
  </div>

  <!-- Capacité -->
  <div class="form-group <%= 'has-error' if @room.errors[:capacity].any? %>">
    <%= form.label :capacity, "Capacité (nombre de personnes)" %>
    <%= form.number_field :capacity, class: "form-control", min: 1, step: 1 %>
    <% if @room.errors[:capacity].any? %>
      <div class="text-danger">
        <%= @room.errors[:capacity].first %>
      </div>
    <% end %>
  </div>

  <!-- Email -->
  <div class="form-group <%= 'has-error' if @room.errors[:mail].any? %>">
    <%= form.label :mail, "Email" %>
    <%= form.email_field :mail, class: "form-control" %>
    <% if @room.errors[:mail].any? %>
      <div class="text-danger">
        <%= @room.errors[:mail].first %>
      </div>
    <% end %>
  </div>

  <!-- Téléphone -->
  <div class="form-group <%= 'has-error' if @room.errors[:phone].any? %>">
    <%= form.label :phone, "Téléphone" %>
    <%= form.telephone_field :phone, class: "form-control" %>
    <% if @room.errors[:phone].any? %>
      <div class="text-danger">
        <%= @room.errors[:phone].first %>
      </div>
    <% end %>
  </div>

  <!-- Cuisine -->
  <div class="form-group">
    <%= form.label :kitchen, "Cuisine" %>
    <%= form.check_box :kitchen, class: "form-check-input" %>
  </div>

  <!-- Champs de tarification -->
  <% [:hourly_rate, :daily_rate, :weekly_rate, :monthly_rate, :weekend_rate, :quarterly_rate, :semiannual_rate, :annual_rate].each do |rate| %>
    <div class="form-group <%= 'has-error' if @room.errors[rate].any? %>">
      <%= form.label rate, t(".#{rate}") %>
      <%= form.number_field rate, step: 0.01, class: "form-control" %>
      <% if @room.errors[rate].any? %>
        <div class="text-danger">
          <%= @room.errors[rate].first %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Photo principale -->
  <div class="form-group <%= 'has-error' if @room.errors[:main_photo].any? %>">
    <%= form.label :main_photo, "Photo principale" %>
    <%= form.file_field :main_photo, class: "form-control-file" %>
    <% if @room.errors[:main_photo].any? %>
      <div class="text-danger">
        <%= @room.errors[:main_photo].first %>
      </div>
    <% end %>

    <!-- Affichage de la photo principale actuelle si elle existe -->
    <% if @room.persisted? && @room.main_photo.attached? %>
      <div class="mt-3">
        <%= image_tag @room.main_photo, class: "img-thumbnail" %>
        <%= link_to 'Supprimer', delete_main_photo_room_path(@room), method: :delete, data: { confirm: 'Êtes-vous sûr de vouloir supprimer cette photo ?' }, class: "btn btn-danger btn-sm mt-2" %>
      </div>
    <% end %>
  </div>

  <!-- Photos supplémentaires -->
  <div class="form-group <%= 'has-error' if @room.errors[:additional_photos].any? %>">
    <%= form.label :additional_photos, "Photos supplémentaires" %>
    <%= form.file_field :additional_photos, multiple: true, class: "form-control-file" %>
    <% if @room.errors[:additional_photos].any? %>
      <div class="text-danger">
        <%= @room.errors[:additional_photos].first %>
      </div>
    <% end %>

    <!-- Affichage des photos supplémentaires actuelles -->
    <% if @room.persisted? && @room.additional_photos.attached? %>
      <div class="row mt-3">
        <% @room.additional_photos.each do |photo| %>
          <div class="col-md-3 text-center">
          <%= image_tag @room.main_photo, class: "img-thumbnail" %>
          <%= link_to 'Supprimer', delete_main_photo_room_path(@room), method: :delete, data: { confirm: 'Êtes-vous sûr de vouloir supprimer cette photo ?' }, class: "btn btn-danger btn-sm mt-2" %>
       </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Soumission -->
  <div class="form-group">
    <%= form.submit "Enregistrer la salle", class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  function checkPhotos() {
    const mainPhotoField = document.querySelector('input[name="room[main_photo]"]');
    const additionalPhotosField = document.querySelector('input[name="room[additional_photos][]"]');
    
    if (!mainPhotoField.files.length && !additionalPhotosField.files.length) {
      alert("Veuillez sélectionner au moins une photo.");
      return false;
    }
    return true;
  }
</script>
