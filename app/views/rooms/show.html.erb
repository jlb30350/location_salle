<div class="room-details-section">
  <h2>Calendrier des réservations</h2>

  <% if @room %>
    <div id="reservation-section" data-room-id="<%= @room.id %>">
      <!-- Navigation du calendrier -->
      <div class="calendar-navigation mb-3">
        <%= link_to "Année précédente", availability_room_path(@room, year: @year.to_i - 1, month: @month), class: "btn btn-secondary" %>
        <%= link_to "Mois précédent", availability_room_path(@room, year: @year, month: @month.to_i - 1), class: "btn btn-secondary" %>
        <%= link_to "Mois suivant", availability_room_path(@room, year: @year, month: @month.to_i + 1), class: "btn btn-secondary" %>
        <%= link_to "Année suivante", availability_room_path(@room, year: @year.to_i + 1, month: @month), class: "btn btn-secondary" %>
      </div>

      <!-- Affichage du mois et de l'année -->
      <h3><%= Date::MONTHNAMES[@month.to_i] %> <%= @year %></h3>

      <!-- Affichage du calendrier sous forme de tableau -->
      <table class="table calendar-table">
        <thead>
          <tr>
            <% Date::ABBR_DAYNAMES.each do |day_name| %>
              <th><%= day_name %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% first_day_of_month = Date.new(@year.to_i, @month.to_i, 1) %>
          <% last_day_of_month = Date.new(@year.to_i, @month.to_i, -1) %>
          <% start_day_of_week = first_day_of_month.wday %>

          <tr>
            <!-- Remplissage des cellules vides avant le premier jour du mois -->
            <% start_day_of_week.times do %>
              <td></td>
            <% end %>

            <% (first_day_of_month..last_day_of_month).each do |date| %>
              <% bookings_on_date = @bookings.select { |booking| booking.start_date <= date && booking.end_date >= date } %>
              <td class="<%= 'reserved' if bookings_on_date.any? %>" title="<%= bookings_on_date.map(&:user).map(&:email).join(", ") %>">
                <% if bookings_on_date.any? %>
                  <span class="reserved-date"><%= date.day %></span>
                <% else %>
                  <button class="btn btn-success available-day" data-date="<%= date %>"><%= date.day %></button>
                <% end %>
              </td>

              <% if date.wday == 6 %> <!-- Fin de semaine, nouvelle ligne -->
                </tr><tr>
              <% end %>
            <% end %>

            <!-- Remplissage des cellules vides après le dernier jour du mois -->
            <% (6 - last_day_of_month.wday).times do %>
              <td></td>
            <% end %>
          </tr>

          <script>
          document.addEventListener("DOMContentLoaded", function() {
            // Fonction pour faire défiler jusqu'à la section du calendrier
            function scrollToCalendarSection() {
              const calendarSection = document.getElementById('reservation-section');
              if (calendarSection) {
                // On utilise scrollIntoView pour faire défiler jusqu'à la section
                calendarSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          
            // Vérifiez si un paramètre 'scroll' est présent dans l'URL pour déclencher le défilement
            if (window.location.search.includes('scroll=true')) {
              scrollToCalendarSection();
            }
          
            // Ajoutez l'événement de clic aux boutons de navigation pour inclure le paramètre 'scroll' dans l'URL
            document.querySelectorAll('.calendar-navigation a').forEach(function(link) {
              link.addEventListener('click', function(event) {
                event.preventDefault(); // Empêche le comportement par défaut du lien
                const url = new URL(link.href);
                url.searchParams.set('scroll', 'true'); // Ajoute le paramètre 'scroll=true'
                window.location.href = url; // Redirige vers la nouvelle URL avec le paramètre ajouté
              });
            });
          });
          </script>
          

        </tbody>
      </table>
    </div> <!-- Fin de reservation-section -->

    <!-- Détails de la salle -->
    <div class="room-info">
      <h1><%= @room.name %></h1>
      <p><strong>Adresse :</strong> <%= @room.city %>, <%= @room.department %></p>
      <p><strong>Capacité :</strong> <%= @room.capacity %> personnes</p>
    </div>

    <!-- Bouton pour inciter à devenir bailleur -->
    <%= link_to 'Cliquez ici pour mettre en ligne une salle', new_room_path, class: 'btn btn-success my-3' %>

    <!-- Bouton de réservation -->
    <%= link_to 'Réserver cette salle', new_room_booking_path(@room), class: 'btn btn-primary my-3' %>

    <!-- Boutons Accueil et Nouvelle recherche -->
    <div class="search-buttons text-center mt-4">
      <%= link_to 'Accueil', root_path, class: 'btn btn-secondary mx-2' %>
      <%= link_to 'Nouvelle recherche', root_path(anchor: 'search-section'), class: 'btn btn-primary mx-2' %>
    </div>

    <!-- Résumé des réservations pour le mois -->
    <h4>Réservations pour <%= Date::MONTHNAMES[@month.to_i] %> <%= @year %></h4>
    <ul>
      <% @bookings.each do |booking| %>
        <li>
          Du <%= booking.start_date.strftime("%d %b %Y") %> au <%= booking.end_date.strftime("%d %b %Y") %> - Réservé par <%= booking.user.email %>
        </li>
      <% end %>
    </ul>

  <% else %>
    <p>Cette salle n'existe pas ou a été supprimée.</p>
  <% end %>
</div>

<!-- Placez ici le code JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  let startDate = null;
  let endDate = null;

  document.querySelectorAll('.available-day').forEach(function(button) {
    button.addEventListener('click', function() {
      const selectedDate = this.getAttribute('data-date');
      console.log("Date sélectionnée :", selectedDate);

      if (!startDate) {
        startDate = selectedDate;
        this.classList.add('btn-primary');
        this.classList.remove('btn-success');
      } else if (!endDate) {
        endDate = selectedDate;
        this.classList.add('btn-primary');
        this.classList.remove('btn-success');

        // Assurez-vous que l'élément avec l'ID 'reservation-section' existe
        const reservationSection = document.getElementById('reservation-section');
        if (reservationSection) {
          const roomId = reservationSection.dataset.roomId;
          console.log(`Redirection vers la page de création de réservation pour la chambre ${roomId}, dates : ${startDate} à ${endDate}`);
          window.location.href = `/rooms/${roomId}/bookings/new?start_date=${startDate}&end_date=${endDate}`;
        } else {
          alert("Erreur : la section de réservation est introuvable.");
          console.error("L'élément avec l'ID 'reservation-section' n'existe pas.");
        }
      }
    });
  });
});
</script>
