<div class="room-details-section">
  <h2><%= @room.name %></h2>

  <!-- Menu déroulant pour choisir la durée -->
  <div class="form-group mt-4">
    <%= label_tag :duration, 'Choisissez la durée' %>
    <%= select_tag :duration, options_for_select([
      ['1 heure', 'hour'], 
      ['1 jour', 'day'], 
      ['2 à 6 jours', 'multiple_days'], 
      ['Week-End', 'weekend'], 
      ['Semaine', 'week'], 
      ['Mois', 'month'], 
      ['Trimestre', 'quarter'], 
      ['Semestre', 'semiannual'], 
      ['Année', 'year']]), 
      class: 'form-control', id: 'duration-select' %>
  </div>

  <h3>Réservations existantes :</h3>
  <div class="reservations-list">
    <% if @bookings.present? %>
      <% @bookings.each do |booking| %>
        <div class="calendar-day reserved">
          <p>Réservé du <%= booking.start_date.strftime('%d/%m/%Y') %> au <%= booking.end_date.strftime('%d/%m/%Y') %></p>
        </div>
      <% end %>
    <% else %>
      <p>Aucune réservation pour le moment.</p>
    <% end %>
  </div>

  <!-- Formulaire pour créer la réservation -->
  <div class="form-group">
    <%= form_with url: room_bookings_path(@room), method: :post, local: true do %>
      <!-- Champs cachés pour envoyer les dates sélectionnées -->
      <input type="hidden" name="booking[start_date]" id="start-date-field" value="">
      <input type="hidden" name="booking[end_date]" id="end-date-field" value="">
      <%= submit_tag "Réserver", class: "btn btn-warning" %>
    <% end %>
  </div>
</div>

<!-- Calendrier cliquable -->
<div class="calendar-navigation mb-3 mt-4">
  <%= link_to "Année précédente", availability_room_path(@room, year: @year.to_i - 1, month: @month), class: "btn btn-secondary" %>
  <%= link_to "Mois précédent", availability_room_path(@room, year: @month == 1 ? @year.to_i - 1 : @year, month: @month == 1 ? 12 : @month.to_i - 1), class: "btn btn-secondary" %>
  <%= link_to "Mois suivant", availability_room_path(@room, year: @month == 12 ? @year.to_i + 1 : @year, month: @month == 12 ? 1 : @month.to_i + 1), class: "btn btn-secondary" %>
  <%= link_to "Année suivante", availability_room_path(@room, year: @year.to_i + 1, month: @month), class: "btn btn-secondary" %>
</div>

<h3><%= Date::MONTHNAMES[@month.to_i] %> <%= @year %></h3>

<!-- Tableau de calendrier -->
<table class="table calendar-table">
  <thead>
    <tr>
      <% Date::ABBR_DAYNAMES.each do |day_name| %>
        <th><%= day_name %></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% begin %>
      <% first_day_of_month = Date.new(@year.to_i, @month.to_i, 1) %>
      <% last_day_of_month = first_day_of_month.end_of_month %>
      <% start_day_of_week = first_day_of_month.wday %>

      <tr>
        <!-- Cellules vides avant le premier jour du mois -->
        <% start_day_of_week.times do %>
          <td></td>
        <% end %>

        <!-- Boucle sur les jours du mois -->
        <% (first_day_of_month..last_day_of_month).each do |date| %>
          <% past_day_class = 'past-day' if date < Date.today %>
          <% is_reserved = @bookings.any? { |booking| booking.start_date <= date && booking.end_date >= date } %>
          <td class="<%= 'reserved' if is_reserved %> <%= past_day_class %>">
            <% if is_reserved %>
              <span class="reserved-date"><%= date.day %></span>
            <% else %>
              <% if date >= Date.today %>
                <button class="btn btn-success available-day" data-date="<%= date %>" data-day="<%= date.wday %>"><%= date.day %></button>
              <% else %>
                <span><%= date.day %></span>
              <% end %>
            <% end %>
          </td>
          <% if date.wday == 6 %> <!-- Fin de semaine, nouvelle ligne -->
            </tr><tr>
          <% end %>
        <% end %>

        <!-- Cellules vides après le dernier jour du mois -->
        <% (6 - last_day_of_month.wday).times do %>
          <td></td>
        <% end %>
      </tr>
    <% rescue ArgumentError => e %>
      <p>Date invalide. Veuillez essayer de nouveau.</p>
    <% end %>
  </tbody>
</table>

<!-- Informations des dates sélectionnées -->
<div class="mt-4">
  <p>Date de début sélectionnée : <span id="start-date-display">Aucune</span></p>
  <p>Date de fin sélectionnée : <span id="end-date-display">Aucune</span></p>
</div>

<!-- JavaScript pour gérer la sélection de dates -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const availableDays = document.querySelectorAll('.available-day');
  const startDateField = document.getElementById('start-date-field');
  const endDateField = document.getElementById('end-date-field');
  const startDateDisplay = document.getElementById('start-date-display');
  const endDateDisplay = document.getElementById('end-date-display');
  let selectedStartDate = null;
  let selectedEndDate = null;

  availableDays.forEach(button => {
    button.addEventListener('click', function() {
      const selectedDate = this.getAttribute('data-date');
      const selectedDuration = document.getElementById('duration-select').value;

      if (selectedDuration === 'multiple_days') {
        if (!selectedStartDate) {
          selectedStartDate = selectedDate;
          startDateField.value = selectedStartDate;
          startDateDisplay.textContent = selectedStartDate;
        } else if (!selectedEndDate) {
          const startDateObj = new Date(selectedStartDate);
          const endDateObj = new Date(selectedDate);

          if (endDateObj > startDateObj) {
            selectedEndDate = selectedDate;
            endDateField.value = selectedEndDate;
            endDateDisplay.textContent = selectedEndDate;
          } else {
            alert("La date de fin doit être après la date de début.");
          }
        }
      } else {
        selectedStartDate = selectedDate;
        startDateField.value = selectedStartDate;
        startDateDisplay.textContent = selectedStartDate;
      }
    });
  });
});
</script>
