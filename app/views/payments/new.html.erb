<h1>Procéder au paiement</h1>

<p>Montant à payer : <%= number_to_currency(@amount) %></p>

<%= form_with url: room_booking_payments_path(@room, @booking), method: :post, local: true do |form| %>
  <div class="form-group">
    <label for="card-element">Informations de la carte</label>
    <div id="card-element"><!-- Stripe card element sera inséré ici --></div>
  </div>

  <div class="form-group">
    <%= form.submit "Payer maintenant", class: "btn btn-primary" %>
  </div>
<% end %>

<!-- Script pour intégrer Stripe -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  var stripe = Stripe('<%= @stripe_publishable_key %>');
  var elements = stripe.elements();
  
  var card = elements.create('card');
  card.mount('#card-element');

  // Gestion des erreurs et soumission du formulaire
  var form = document.querySelector('form');
  form.addEventListener('submit', function(event) {
    event.preventDefault();

    stripe.createToken(card).then(function(result) {
      if (result.error) {
        // Afficher les erreurs
        alert(result.error.message);
      } else {
        // Envoyer le token au backend
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', result.token.id);
        form.appendChild(hiddenInput);

        form.submit();
      }
    });
  });
</script>
